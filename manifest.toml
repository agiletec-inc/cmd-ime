version = 1
mode = "docker-first"
project = []

[workspace]
name = "cmd-ime"
package_manager = "pnpm@10.22.0"
service = "workspace"
image = "node:22-alpine"
workdir = "/app"
volumes = ["workspace-node-modules:/app/node_modules"]

[catalog]

[workspaces]
apps = []
libs = []

[dev]
autostart = []

[apps]

[libs]

[docker]
baseImage = ""
workdir = ""

[service]

[rule.verify]
commands = [
    "just lint",
    "just test-all",
]

[rule.ci]
commands = [
    "just lint",
    "just test-all",
    "just typecheck",
]

[packages]
workspaces = []

[packages.catalog]
next = "15.4.0"
react = "19.0.0"
typescript = "5.8.0"
vitest = "2.0.0"

[packages.root.dependencies]

[packages.root.devDependencies]
typescript = "5.6.2"
eslint = "9.3.0"

[packages.root.optionalDependencies]

[packages.root.scripts]

[packages.root.engines]

[packages.root.pnpm]
onlyBuiltDependencies = []

[packages.root.pnpm.overrides]

[packages.root.pnpm.peerDependencyRules]
ignoreMissing = []

[packages.root.pnpm.peerDependencyRules.allowedVersions]

[packages.root.pnpm.allowedScripts]

[[packages.app]]
pattern = "apps/*"

[packages.app.dependencies]

[packages.app.devDependencies]

[packages.app.scripts]

[guards]
deny = [
    "git commit --no-verify",
]

[guards.wrap]
"git commit" = "./scripts/commit.sh"

[guards.deny_with_message]
"git commit --no-verify" = "Bypasses version checks - use ./scripts/commit.sh instead"
"pnpm" = "Direct host execution forbidden - use docker compose exec workspace pnpm"
"npm" = "Direct host execution forbidden - use docker compose exec workspace npm"

# ========================================
# Project Metadata
# ========================================
[project.metadata]
description = "âŒ˜IME (Command IME) - Lightweight macOS app for switching between alphanumeric and kana input"
license = "MIT"
minimum_macos = "14.0"
primary_target = "apps/cmd-ime-swift"
architecture = "universal"

# ========================================
# Version Management Policy
# ========================================
[policies.versioning]
enforce_on_commit = true
current_version = "1.0.1"

[policies.versioning."apps/cmd-ime-swift"]
require_bump_on_paths = [
  "apps/cmd-ime-swift/Sources/**/*.swift",
  "apps/cmd-ime-swift/scripts/build_app.sh",
  "apps/cmd-ime-swift/scripts/package.sh",
]

version_files = [
  "apps/cmd-ime-swift/scripts/build_app.sh",
  "apps/cmd-ime-swift/scripts/package.sh",
]

version_key = "CFBundleShortVersionString"
bundle_version_key = "CFBundleVersion"
bump_script = "./scripts/bump_version.sh"

# ========================================
# Implementation Policy
# ========================================
[policies.implementation]
require_official_docs = true
require_version_check = true
require_api_reference = true
no_speculation = true

[policies.implementation.workflow]
steps = [
  "1. Identify library/framework/API being used",
  "2. Query official documentation via MCP (Serena/WebSearch)",
  "3. Check latest stable version",
  "4. Compare with project's current version",
  "5. Read official API reference",
  "6. Design implementation based on official docs (NOT speculation)",
  "7. Implement with proper error handling",
  "8. Test implementation",
  "9. Bump version if source code changed",
  "10. Commit via wrapper script",
]

[policies.implementation.mcp]
documentation_providers = ["serena", "webfetch", "websearch"]
version_registries = ["npm", "cargo", "homebrew"]

# ========================================
# Workflows
# ========================================
[workflows."swift-feature-development"]
description = "Standard workflow for cmd-ime-swift feature development"
triggers = ["apps/cmd-ime-swift/Sources/**"]

[[workflows."swift-feature-development".steps]]
name = "Verify official documentation"
required = true

[[workflows."swift-feature-development".steps]]
name = "Check current versions"
required = true

[[workflows."swift-feature-development".steps]]
name = "Implement feature"
required = true

[[workflows."swift-feature-development".steps]]
name = "Write tests"
required = true

[[workflows."swift-feature-development".steps]]
name = "Run tests"
required = true
run = "cd apps/cmd-ime-swift && swift test"

[[workflows."swift-feature-development".steps]]
name = "Bump version"
required = true
run = "./scripts/bump_version.sh patch"

[[workflows."swift-feature-development".steps]]
name = "Build app"
required = true
run = "cd apps/cmd-ime-swift && bash scripts/build_app.sh"

[[workflows."swift-feature-development".steps]]
name = "Commit changes"
required = true
run = "./scripts/commit.sh"

# ========================================
# Critical Implementation Notes
# ========================================
[critical_notes.accessibility]
rule = "Only show permission prompt on FIRST launch"

[critical_notes.login_item]
rule = "Login item management - DO NOT comment out setLaunchAtStartup() calls"
bundle_id = "com.kazuki.cmdime-helper"
macos_13_plus = "Use SMAppService.mainApp (no helper app needed)"
macos_12_minus = "Use SMLoginItemSetEnabled with helper app"

# ========================================
# Agent Execution Rules
# ========================================
[agent_rules.execution]
default_mode = "operator"
priority = "action"
cli_only = true
evidence_required = true

[agent_rules.failure_handling]
never_say_cannot = true
always_provide_alternative = true
max_excuse_length = "1 line"

[agent_rules.response_style]
brevity = "mandatory"
no_poetry = true
proof_required = true

[agent_rules.continuation]
auto_continue = true
create_plan_if_missing = true
only_confirm_dangerous = true
